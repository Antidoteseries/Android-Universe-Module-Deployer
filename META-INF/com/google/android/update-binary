#!/sbin/sh
# Installer manager for recovery
# This is a part of Android Universe Module Deployer
# Author: Antidotes
# Source: https://github.com/Antidoteseries/Android-Universe-Module-Deployer
# Licenced by GPLv3
# Version: 0.2.1 Alpha
###########################################################################

EXTMOD()
{
  case "$MODE" in
  ZIP)
    "$UNZIPI" -o "$SOURCE" "$MODEXTED" -d "$TMP"/AUMD/
    export TARGET="$TMP"/AUMD/"${MODEXTED%.zip}"
    "$UNZIPI" -o "$TMP"/AUMD/"$MODEXTED" -d "$TARGET"
    ;;
  Direct)
    "$UNZIPI" -o "$SOURCE" "$MODEXTED"/* -d "$TMP"/AUMD/
    export TARGET="$TMP"/AUMD/"${MODEXTED}"
    ;;
  esac
}

READINI()
{
 local INIFILE=$1; local INISECT=$2; local INIKEY=$3
 local RESULT=`awk -F '=' '/\['$INISECT'\]/ {FIND=1} FIND==1 && $1~/'$INIKEY'/ {print $2;exit}' $INIFILE`
 echo $RESULT
}

# Initial Define
export SOURCE="$3"
export OUTFD="/proc/self/fd/$2"
export TMP="/tmp"
case "$(uname -m)" in
  *86*) export ARCH="x86";;
  *ar*) export ARCH="arm";;
esac
# Get Package Infomation
unzip -o "$SOURCE" Config.ini -d "$TMP"
PKGNAME=$(READINI $TMP/Config.ini Package PackageName)
DEVICE=$(READINI $TMP/Config.ini Package Device)
MODE=$(READINI $TMP/Config.ini Package Mode)
# Set SELinux to Permissive
setenforce 0
# Detect Project Treble
mount -w /dev/block/bootdevice/by-name/system /system
if [ -d "/system/system" ];then
  export PT="1"
else
  export PT="0"
fi
if [ "$PT" == "1" ];then
  mount -w /dev/block/bootdevice/by-name/vendor /vendor
  export BUILD=/system/system/build.prop
  export BUILDV=/vendor/build.prop
else
  export BUILD=/system/build.prop
fi
# Dectet Sony Xperia Device
if [ "grep "ro.product.brand" $BUILD" == "ro.product.brand=Sony" ];then
  mount -w /dev/block/bootdevice/by-name/oem /oem
fi
# Prepare to Deploy
echo "ui_print ===========================================" > "$OUTFD"
if [ -z $PKGNAME ];then
  echo "ui_print Android Universe Module Deployer" > "$OUTFD"
else
  echo "ui_print $PKGNAME" > "$OUTFD"
  echo "ui_print Powered by Android Universe Module Deployer" > "$OUTFD"
fi
echo "ui_print ===========================================" > "$OUTFD"
# Get Modules list
unzip -o "$SOURCE" bin/unzip -d "$TMP"
export UNZIPI="$TMP"/bin/unzip
chmod 755 "$UNZIPI"
"$UNZIPI" -Z -1 "$SOURCE" | grep Modules > "$TMP"/ModulesList.txt
case "$MODE" in
  ZIP)
    sed -i '1d' "$TMP"/ModulesList.txt
    ;;
  Direct)
    :>$TMP/ModulesListNew.txt
    sed -i '1d' "$TMP"/ModulesList.txt
    for MODENTRY in `cat $TMP/ModulesList.txt`;do
      MODFILE=`echo $MODENTRY | awk -F '\/' '{print "Modules/"$2}'`
      if [ "$MODFILE" != "$(tail -n 1 "$TMP"/ModulesListNew.txt)" ];then
        echo $MODFILE >> "$TMP"/ModulesListNew.txt
      fi
    done
    rm $TMP/ModulesList.txt
    mv $TMP/ModulesListNew.txt $TMP/ModulesList.txt
    ;;
  *)
    echo "ui_print ERROR: Unknown Modules Mode" > "$OUTFD"
    exit 1
    ;;
esac
# Deploy Modules
for MODEXTED in `cat $TMP/ModulesList.txt`;do
  EXTMOD
  # Get Modules Infomation
  MODNAME=$(READINI $TARGET/Config.ini Module ModuleName)
  MODVER=$(READINI $TARGET/Config.ini Module Version)
  MODVERCODE=$(READINI $TARGET/Config.ini Module VersionCode)
  MODPART=$(READINI $TARGET/Config.ini Module ModulePart)
  echo "ui_print Now installing ${MODNAME}" > "$OUTFD"
  # Get Modules Files Target
  echo "ui_print - Deploying Files" > "$OUTFD"
  for MODPD in `echo $MODPART | awk -F ',' '{len=split($0,n); for(i=1;i<=len;++i) print n[i]}'`;do
    case "$MODPD" in
    system)
      if [ "$PT" == "1" ];then
        cp -rf "$TARGET/system" "/system"
      else
        cp -rf "$TARGET/system" "/"
      fi
      ;;
    vendor)
      if [ "$PT" == "1" ];then
        cp -rf "$TARGET/vendor" "/vendor"
      else
        cp -rf "$TARGET/vendor" "/system"
      fi
      ;;
    sony_oem)
      cp -rf "$TARGET/oem" "/"
      ;;
    esac
  done
  if [ -e $TARGET/Config.sh ];then
    echo "ui_print - Running Additional Script" > "$OUTFD"
    sh "$TARGET"/Config.sh
  fi
  rm -rf "$TARGET" 
  echo "ui_print - Install Completed" > "$OUTFD"
done
# Set Permission
echo "ui_print ===========================================" > "$OUTFD"
echo "ui_print Deploy Completed" > "$OUTFD"
exit 0
